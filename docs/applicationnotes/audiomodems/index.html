<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.69.2"><meta name=description content><link rel=apple-touch-icon sizes=180x180 href=/docs/images/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/docs/images/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/docs/images/favicon/favicon-16x16.png><link rel=manifest href=/docs/images/favicon/site.webmanifest><link rel=mask-icon href=/docs/images/favicon/safari-pinned-tab.svg color=#5bbad5><link rel="shortcut icon" href=/docs/images/favicon/favicon.ico><meta name=msapplication-TileColor content="#8c1515"><meta name=msapplication-config content="/docs/images/favicon/browserconfig.xml"><meta name=theme-color content="#8c1515"><title>Audio Modems and the PIC :: The SPDL Docs Repository</title><link href=/docs/css/nucleus.css?1588666478 rel=stylesheet media="screen, print"><link href=/docs/css/fontawesome-all.min.css?1588666478 rel=stylesheet media="screen, print"><link href=/docs/css/hybrid.css?1588666478 rel=stylesheet media="screen, print"><link href=/docs/css/featherlight.min.css?1588666478 rel=stylesheet media="screen, print"><link href=/docs/css/perfect-scrollbar.min.css?1588666478 rel=stylesheet media="screen, print"><link href=/docs/css/auto-complete.css?1588666478 rel=stylesheet media="screen, print"><link href=/docs/css/atom-one-dark-reasonable.css?1588666478 rel=stylesheet media="screen, print"><link href=/docs/css/theme.css?1588666478 rel=stylesheet media="screen, print"><link href=/docs/css/hugo-theme.css?1588666478 rel=stylesheet media="screen, print"><link href=/docs/css/theme-stanford.css?1588666478 rel=stylesheet media="screen, print"><script src=/docs/js/jquery-3.3.1.min.js?1588666478></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><link rel=stylesheet href=/docs/bigfoot.css><link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:300,400,500|Oswald:500&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=UA-71199601-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-71199601-2');</script></head><body data-url=/docs/applicationnotes/audiomodems/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=http://spdldaemon.github.io/docs><svg style="width:100%;height:100%" viewBox="0 0 109 109" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"><g transform="translate(-41.3 -52.8)" display="none"><g fill="none" stroke="#4d4f53" stroke-width="2"><path d="m46.4 101 4.08 4.08"/><path d="m49.4 98.4 4.08 4.08"/><path d="m52.5 95.3 4.08 4.08"/><path d="m55.6 92.2 4.08 4.08"/><path d="m58.7 89.1 4.08 4.08"/><path d="m61.7 86.1 4.08 4.08"/><path d="m64.8 83 4.08 4.08"/><path d="m67.9 79.9 4.08 4.08"/><path d="m71 76.8 4.08 4.08"/><path d="m74.1 73.8 4.08 4.08"/><path d="m77.1 70.7 4.08 4.08"/><path d="m80.2 67.6 4.08 4.08"/><path d="m83.3 64.5 4.08 4.08"/><path d="m86.4 61.5 4.08 4.08"/><path d="m89.4 58.4 4.08 4.08"/><path d="m92.5 55.3 4.08 4.08"/></g><g><rect transform="rotate(-45)" x="-44.1" y="100" width="4.16" height="14.7" ry="2.08" fill="#0000c8"/><rect transform="rotate(-45)" x="27.3" y="100" width="4.16" height="14.7" ry="2.08" fill="#0000c8"/><rect transform="rotate(-45)" x="-44.1" y="112" width="4.16" height="14.7" ry="2.08" display="inline" fill="#c8c800"/><rect transform="rotate(225)" x="-114" y="-47.4" width="4.16" height="14.7" ry="2.08" display="inline" fill="#c8c800"/></g><g fill="#c80000"><rect transform="rotate(-45)" x="-44.1" y="164" width="8.7" height="14.7" ry="2.08" display="inline"/><rect transform="rotate(-45)" x="22.8" y="123" width="8.7" height="14.7" ry="2.08" display="inline"/><rect transform="rotate(45)" x="110" y="-21.6" width="8.7" height="14.7" ry="2.08" display="inline"/><rect transform="rotate(45)" x="177" y="18.1" width="8.7" height="14.7" ry="2.08" display="inline"/></g></g><g transform="translate(-41.3 -52.8)" display="none"><rect x="30.9" y="53.1" width="134" height="110" fill="#dc1010" fill-opacity=".992"/></g><g transform="translate(-41.3 -52.8)" fill="none" stroke="#f4f4f4" stroke-opacity=".588" stroke-width="2"><g transform="rotate(-45.4 94.5 112)"><path d="m66.1 66.2v5.76"/><path d="m70.5 66.2v5.76"/><path d="m74.8 66.2v5.76"/><path d="m79.2 66.2v5.76"/><path d="m83.5 66.2v5.76"/><path d="m87.9 66.2v5.76"/><path d="m92.2 66.2v5.76"/><path d="m96.6 66.2v5.76"/><path d="m101 66.2v5.76"/><path d="m105 66.2v5.76"/><path d="m110 66.2v5.76"/><path d="m114 66.2v5.76"/><path d="m118 66.2v5.76"/><path d="m123 66.2v5.76"/><path d="m127 66.2v5.76"/><path d="m131 66.2v5.76"/></g><g transform="rotate(225 114 68.5)"><path d="m66.1 66.2v5.76"/><path d="m70.5 66.2v5.76"/><path d="m74.8 66.2v5.76"/><path d="m79.2 66.2v5.76"/><path d="m83.5 66.2v5.76"/><path d="m87.9 66.2v5.76"/><path d="m92.2 66.2v5.76"/><path d="m96.6 66.2v5.76"/><path d="m101 66.2v5.76"/><path d="m105 66.2v5.76"/><path d="m110 66.2v5.76"/><path d="m114 66.2v5.76"/><path d="m118 66.2v5.76"/><path d="m123 66.2v5.76"/><path d="m127 66.2v5.76"/><path d="m131 66.2v5.76"/></g><g transform="rotate(-45.4 192 71.3)"><path d="m66.1 66.2v5.76"/><path d="m70.5 66.2v5.76"/><path d="m74.8 66.2v5.76"/><path d="m79.2 66.2v5.76"/><path d="m83.5 66.2v5.76"/><path d="m87.9 66.2v5.76"/><path d="m92.2 66.2v5.76"/><path d="m96.6 66.2v5.76"/><path d="m101 66.2v5.76"/><path d="m105 66.2v5.76"/><path d="m110 66.2v5.76"/><path d="m114 66.2v5.76"/><path d="m118 66.2v5.76"/><path d="m123 66.2v5.76"/><path d="m127 66.2v5.76"/><path d="m131 66.2v5.76"/></g><g transform="rotate(44.6 1.09 64.4)"><path d="m66.1 66.2v5.76"/><path d="m70.5 66.2v5.76"/><path d="m74.8 66.2v5.76"/><path d="m79.2 66.2v5.76"/><path d="m83.5 66.2v5.76"/><path d="m87.9 66.2v5.76"/><path d="m92.2 66.2v5.76"/><path d="m96.6 66.2v5.76"/><path d="m101 66.2v5.76"/><path d="m105 66.2v5.76"/><path d="m110 66.2v5.76"/><path d="m114 66.2v5.76"/><path d="m118 66.2v5.76"/><path d="m123 66.2v5.76"/><path d="m127 66.2v5.76"/><path d="m131 66.2v5.76"/></g></g><g transform="translate(-41.3 -52.8)"><rect transform="rotate(-45.4)" x="-46.7" y="106" width="75.1" height="75.1" ry="3.86" fill="none" stroke="#f4f4f4" stroke-linejoin="round"/><circle transform="rotate(-45.4)" cx="-40.5" cy="112" r="2.27" fill="#f4f4f4"/></g><g transform="translate(-41.3 -52.8)" display="none" word-spacing="0"><text transform="rotate(-45.4)" x="-18.984667" y="126.87369" fill="#2d2e29" font-family="sans-serif" font-size="9.76" letter-spacing="0" stroke-width=".183" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal;line-height:1.25"><tspan x="-18.984667" y="126.87369" fill="#f4f4f4" font-size="11.3" stroke-width=".183"><tspan font-family="Raleway" font-weight="300">ME</tspan><tspan font-family="Orbitron" font-weight="bold">218</tspan></tspan></text><text transform="rotate(-45.4)" x="-38.931206" y="138.35268" fill="#f4f4f4" font-family="'League Mono'" font-size="11.3" font-weight="200" letter-spacing="2.05" stroke-width=".308" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal;line-height:1"><tspan x="-38.931206" y="138.35268"><tspan font-weight="bold">S</tspan><tspan fill="#f4f4f4" fill-opacity=".784">MART</tspan><tspan font-weight="bold">P</tspan><tspan fill="#f4f4f4" fill-opacity=".855">R</tspan></tspan><tspan x="-38.931206" y="149.78459"><tspan fill="#f4f4f4" fill-opacity=".855">ODUCT</tspan><tspan font-weight="bold">D</tspan><tspan fill="#f4f4f4" fill-opacity=".855">E</tspan></tspan><tspan x="-38.931206" y="161.21651"><tspan fill="#f4f4f4" fill-opacity=".855">SIGN</tspan><tspan font-weight="bold">L</tspan><tspan fill="#f4f4f4" fill-opacity=".855">AB</tspan></tspan><tspan x="-38.931206" y="172.64842" fill-opacity=".855">ORATORY</tspan></text></g><g transform="translate(1.32e-6)" fill="#f4f4f4"><g><path d="m41.6 43.9-4.94-4.87 1.63 6.05-.254.257-6.07-1.55 4.94 4.87-.404.41-5.71-5.63.404-.41 6.43 1.65-1.74-6.41.404-.41 5.71 5.63z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m46.8 37.9.37.365-3.75 3.8-5.71-5.63 3.68-3.73.37.365-3.27 3.32 2.24 2.21 2.86-2.9.354.349-2.86 2.9 2.37 2.34z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m46.8 27.1q.222-.225.509-.339.295-.122.59-.116.295-.01.591.108.288.11.513.332l1.29 1.27q.233.23.347.516.114.287.116.59.002.287-.116.584-.11.288-.332.513l-3.46 3.51q-.0555.0563-.0073.104l1.13 1.11q.0562.0555.112-795e-6l4.56-4.62 1.05 1.04-5.65 5.73-2.23-2.2q-.225-.222-.339-.509-.122-.295-.124-.582-.0021-.303.108-.591.11-.288.34-.521l3.46-3.51q.0555-.0563.0073-.104l-1.29-1.27q-.0562-.0555-.112 795e-6l-3.46 3.51q-.0555.0563 765e-6.112l.434.428-1.04 1.05-.434-.428q-.225-.222-.339-.509-.122-.295-.124-.582-.0021-.303.108-.591.11-.288.34-.521z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m50.1 23.7 1.15-1.17 5.79 5.71-1.04 1.05-4.25-4.19q.0258.263.0435.519.0176.239.0433.487l-1.37 1.39z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m59.8 18.4q.153.151.266.341.113.175.154.39.216.0384.4.157.184.102.337.253l1.28 1.26q.233.23.347.516.114.287.116.59.002.287-.116.584-.11.288-.332.513l-3.46 3.51q-.23.233-.516.347-.287.114-.582.124-.295-.0059-.584-.116-.288-.11-.521-.34l-1.28-1.26q-.322-.317-.42-.731-.416-.0929-.737-.41l-1.13-1.12q-.225-.222-.339-.509-.122-.295-.124-.582-.0021-.303.108-.591.11-.288.34-.521l3.46-3.51q.198-.201.453-.314.255-.13.526-.147.271-.0338.535.0362.272.062.496.22zm.119 2.19q-.0482-.0475-.104.0087l-3.46 3.51q-.0555.0563-.0073.104l1.28 1.26q.0562.0555.112-794e-6l3.46-3.51q.0555-.0563-766e-6-.112zm-2.28-2.25q-.0562-.0555-.112 795e-6l-3.46 3.51q-.0555.0563 766e-6.112l1.21 1.19q.0562.0555.112-794e-6l3.46-3.51q.0555-.0563-766e-6-.112z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m29.1 66.1q.692-.348 1.26-.536.557-.195 1.2-.136.647.0514 1.19.59.884.872.684 1.86-.201.991-1.14 1.95-1.59 1.61-3.28 1.03l.516-1.57q.456.164.918.0654.462-.099.859-.501.388-.394.473-.802.0769-.416-.253-.741-.289-.285-.712-.211-.423.0748-1.06.383-.613.3-1.16.487-.542.179-1.21.12-.671-.0592-1.23-.614-.764-.753-.539-1.69.225-.936 1.09-1.81.666-.675 1.48-.904.805-.237 1.56.0929l-.437 1.49q-.456-.18-.871-.0977-.423.0748-.74.396-.349.354-.426.689-.0775.336.172.582.225.222.6.227.367-.0026.797-.213z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/></g><g fill-opacity=".784"><path d="m40 61.9-4.92-4.41 3.25 5.38-.444.45-5.43-3.18 4.48 4.86-.412.418-5.3-5.88.499-.506 4.19 2.52 1.73 1.09-1.12-1.71-2.57-4.16.499-.506 5.95 5.22z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m43.8 54.3-2.05 2.07 1.45 2.26-.42.426-4.38-6.81 1.22-1.24 6.87 4.29-.42.426zm-.465-.284-3.66-2.3-.555.563 2.35 3.63z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m48.5 45.1q1.41 1.39.497 2.65l3.57 1.43-.452.458-3.51-1.44-1.31 1.33 2.5 2.47-.404.41-5.63-5.55 1.7-1.72q.42-.426.85-.653.429-.227.989-.119.56.108 1.2.742zm-1.58 4.05 1.53-1.55q.42-.426.369-.921-.0515-.511-.719-1.17-.627-.618-1.13-.623-.503-.0204-.931.414l-1.49 1.51z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m53.6 37.6-1.62 1.64 5.25 5.18-.404.41-5.25-5.18-1.61 1.63-.378-.373 3.63-3.68z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/></g><path d="m61 36.8 1.85 1.82-1.21 1.23-5.63-5.55 1.83-1.86q.468-.474.961-.749.493-.291 1.17-.192.679.0831 1.46.852 1.22 1.2 1.08 2.14-.153.927-.89 1.67zm-.981-.967.404-.41q.285-.289.388-.522t-.0116-.519q-.114-.303-.516-.699-.37-.365-.65-.45-.28-.102-.511.0036-.231.105-.516.395l-.404.41z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><g fill-opacity=".784"><path d="m67.1 26.2q1.41 1.39.497 2.65l3.57 1.43-.452.458-3.51-1.44-1.31 1.33 2.5 2.47-.404.41-5.63-5.55 1.7-1.72q.42-.426.85-.653.429-.227.989-.119t1.2.742zm-1.58 4.05 1.53-1.55q.42-.426.369-.921-.0515-.511-.719-1.17-.627-.618-1.13-.623-.503-.0204-.931.414l-1.49 1.51z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m40.5 77.8q-.864.876-1.98.772-1.12-.12-2.76-1.74-1.63-1.61-1.76-2.72-.128-1.12.736-2 .856-.868 1.97-.748 1.12.104 2.75 1.71 1.64 1.62 1.77 2.74.127 1.11-.729 1.98zm-.386-.38q.436-.442.528-.954.1-.52-.272-1.24-.372-.732-1.35-1.7-.981-.967-1.71-1.32-.721-.362-1.24-.255-.51.0994-.946.541-.436.442-.536.962-.1.52.264 1.24.372.716 1.35 1.68.981.967 1.71 1.34.729.354 1.25.247.518-.107.954-.549z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m40.9 66q.571-.579 1.12-.846.541-.275 1.47.0217.936.289 2.23 1.56 1.29 1.28 1.6 2.21.31.924.0502 1.48-.268.545-.838 1.12l-1.26 1.28-5.63-5.55zm5.41 5.02q.491-.498.584-1.03.0921-.527-.288-1.2-.38-.692-1.31-1.61-.932-.919-1.62-1.28-.689-.378-1.22-.279-.526.0995-1.02.598l-1.01 1.03 4.87 4.8z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m52.9 65.2q-.571.579-1.15.75-.582.156-1.29-.151-.705-.314-1.6-1.2l-3.36-3.31.404-.41 3.44 3.39q.723.713 1.28.981.553.26.999.145.454-.123.898-.573.452-.458.56-.906.109-.448-.167-.989-.275-.557-.999-1.27l-3.44-3.39.404-.41 3.36 3.31q.9.888 1.22 1.59t.177 1.28q-.156.576-.734 1.16z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m60 56.3q.204.629.0089 1.28-.203.64-.79 1.23-.919.932-2.07.733-1.15-.215-2.66-1.71-1.5-1.48-1.72-2.63-.216-1.16.712-2.1 1.13-1.14 2.53-.728l-.18.584q-.56-.188-1.04-.0566-.47.123-.922.581-.713.723-.483 1.68t1.53 2.24q1.31 1.29 2.26 1.52.951.225 1.66-.491.919-.932.577-1.95z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m61.8 45.6-1.62 1.64 5.25 5.18-.404.41-5.25-5.18-1.61 1.63-.378-.373 3.63-3.68z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/></g><path d="m65.8 40.7q.61-.619 1.2-.926.596-.315 1.56-.0508.96.249 2.25 1.52 1.29 1.28 1.56 2.24.27.948-.0371 1.55-.299.593-.91 1.21l-1.72 1.74-5.63-5.55zm4.51 4.72q.452-.458.521-.85.0611-.4-.23-.861-.299-.469-1.04-1.2-.739-.729-1.2-1.01-.473-.292-.864-.217-.399.0666-.85.525l-.373.378 3.67 3.61z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><g fill-opacity=".784"><path d="m71.3 35.9 2.3 2.27 2.23-2.26.37.365-2.23 2.26 2.2 2.17 2.66-2.69.378.373-3.06 3.1-5.63-5.55 3.06-3.1.378.373z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m45.3 82.7q1.34-.608 2.21-.702.861-.102 1.46.493.715.705.602 1.61-.114.887-.954 1.74-1.39 1.41-2.83.994l.203-.624q.576.188 1.13.0081.549-.187 1.11-.758.674-.683.757-1.33.0832-.663-.439-1.18-.434-.428-1.1-.359-.678.0606-1.71.547-.971.47-1.8.508-.83.0218-1.41-.549-.643-.634-.513-1.43.138-.799.875-1.55 1.21-1.23 2.58-.768l-.187.592q-.544-.204-1.03-.0647-.486.123-.978.621-.539.547-.663 1.12-.116.568.334 1.01.78.769 2.35.0634z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m49.7 74.1 4.87 4.8 1.3-1.32.378.373-3 3.04-.378-.373 1.29-1.31-4.87-4.8-1.29 1.31-.378-.373 3-3.04.378.373z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m62 70.6q.108.566-.0871 1.25-.195.68-.853 1.35-.919.932-2.07.733-1.14-.208-2.66-1.71-1.5-1.48-1.69-2.66-.184-1.2.751-2.14.555-.563 1.14-.71.59-.148 1.3.0628l-.18.584q-.576-.188-1.01-.0888-.438.0909-.874.533-1.51 1.54.978 3.99 1.31 1.29 2.26 1.52.952.225 1.66-.491.935-.948.753-1.97l-1.76-1.74-1.24 1.26-.378-.373 1.65-1.67z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m63.1 59.8 5.63 5.55-.539.547-7.21-2.69 5 4.93-.404.41-5.63-5.55.539-.547 7.21 2.69-5-4.93z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/></g><path d="m74.4 57.5.981.967-3.52 3.57-5.63-5.55 1.21-1.23 4.65 4.58z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><g fill-opacity=".784"><path d="m78.7 51.5-2.05 2.07 1.45 2.26-.42.426-4.38-6.81 1.22-1.24 6.87 4.29-.42.426zm-.465-.284-3.66-2.3-.555.563 2.35 3.63z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m83.7 44.2q-.0322-.0317.326-.138.366-.114.862-.006.488.1 1.02.624.812.801.881 1.53.061.726-.645 1.44l-1.89 1.92-5.63-5.55 1.55-1.57q.428-.434.818-.652.382-.226.893-.134.503.0843 1.11.679.482.476.645.89t.133.702q-.0299.288-.0621.256zm-2.13 1.92 1.43-1.45q.357-.362.242-.84t-.662-1.02q-.587-.579-1.03-.568-.431.003-.827.405l-1.32 1.33zm4.18 1.18q.515-.522.456-1.04-.0595-.518-.711-1.16-.547-.539-1.08-.559-.527-.0282-.892.341l-1.59 1.61 2.34 2.31z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m56.8 93.9q-.864.876-1.98.772-1.12-.12-2.76-1.74-1.63-1.61-1.76-2.72-.128-1.12.736-2 .856-.868 1.97-.748 1.12.104 2.75 1.71 1.64 1.62 1.77 2.74.127 1.11-.729 1.98zm-.386-.38q.436-.442.528-.954.1-.52-.272-1.24-.372-.732-1.35-1.7t-1.71-1.32q-.721-.362-1.24-.255-.51.0994-.946.541-.436.442-.536.962-.1.52.264 1.24.372.716 1.35 1.68t1.71 1.34q.729.354 1.25.247.518-.107.954-.549z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m60.5 81.7q1.41 1.39.497 2.65l3.57 1.43-.452.458-3.51-1.44-1.31 1.33 2.5 2.47-.404.41-5.63-5.55 1.7-1.72q.42-.426.85-.653.429-.227.989-.119.56.108 1.2.742zm-1.58 4.05 1.53-1.55q.42-.426.369-.921-.0515-.511-.719-1.17-.627-.618-1.13-.623-.503-.0204-.931.414l-1.49 1.51z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m68.2 78.3-2.05 2.07 1.45 2.26-.42.426-4.38-6.81 1.22-1.24 6.87 4.29-.42.426zm-.465-.284-3.66-2.3-.555.563 2.35 3.63z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m71.8 67.9-1.62 1.64 5.25 5.18-.404.41-5.25-5.18-1.61 1.63-.378-.373 3.63-3.68z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m81.5 68.8q-.864.876-1.98.772-1.12-.12-2.76-1.74-1.63-1.61-1.76-2.72-.128-1.12.736-2 .856-.868 1.97-.748 1.12.104 2.75 1.71 1.64 1.62 1.77 2.74.127 1.11-.729 1.98zm-.386-.38q.436-.442.528-.954.1-.52-.272-1.24-.372-.732-1.35-1.7-.981-.967-1.71-1.32-.721-.362-1.24-.255-.51.0994-.946.541-.436.442-.536.962-.1.52.264 1.24.372.716 1.35 1.68.981.967 1.71 1.34.729.354 1.25.247.518-.107.954-.549z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m85.3 56.6q1.41 1.39.497 2.65l3.57 1.43-.452.458-3.51-1.44-1.31 1.33 2.5 2.47-.404.41-5.63-5.55 1.7-1.72q.42-.426.85-.653.429-.227.989-.119t1.2.742zm-1.58 4.05 1.53-1.55q.42-.426.369-.921-.0515-.511-.719-1.17-.627-.618-1.13-.623-.503-.0204-.931.414l-1.49 1.51z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m90.1 48.7 1.7 4.97 2.28 2.25-.404.41-2.27-2.24-5.01-1.63.452-.458 4.2 1.35.0238-.0241-1.42-4.17z" style="font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/></g></g></svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/docs/js/lunr.min.js?1588666478></script><script type=text/javascript src=/docs/js/auto-complete.js?1588666478></script><script type=text/javascript>var baseurl="http:\/\/spdldaemon.github.io\/docs";</script><script type=text/javascript src=/docs/js/search.js?1588666478></script></div><div class=highlightable><ul class=topics><li data-nav-id=/docs/tools/ title=Tools class=dd-item><a href=/docs/tools/><b>1. </b>Tools</a><ul><li data-nav-id=/docs/tools/onshape/ title=Onshape class=dd-item><a href=/docs/tools/onshape/>Onshape</a></li><li data-nav-id=/docs/tools/kicad/ title=KiCad class=dd-item><a href=/docs/tools/kicad/>KiCad</a><ul><li data-nav-id=/docs/tools/kicad/usingkicad/ title="Using KiCad" class=dd-item><a href=/docs/tools/kicad/usingkicad/>Using KiCad</a></li><li data-nav-id=/docs/tools/kicad/schematiccapture/ title="Schematic Capture" class=dd-item><a href=/docs/tools/kicad/schematiccapture/>Schematic Capture</a></li></ul></li></ul></li><li data-nav-id=/docs/applicationnotes/ title="Application Notes" class="dd-item
parent"><a href=/docs/applicationnotes/><b>2. </b>Application Notes</a><ul><li data-nav-id=/docs/applicationnotes/magneticfieldsensing/ title="Magnetic Field Sensing" class=dd-item><a href=/docs/applicationnotes/magneticfieldsensing/>Magnetic Field Sensing</a></li><li data-nav-id=/docs/applicationnotes/audiomodems/ title="Audio Modems and the PIC" class="dd-item
parent
active"><a href=/docs/applicationnotes/audiomodems/>Audio Modems and the PIC</a></li></ul></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://me218archive.stanford.edu><i class="fas fa-archive"></i>The ME 218 Archive</a></li><li><a class=padding href=https://github.com/SPDLDaemon/spdl-docs-master><i class="fab fa-github"></i>Github Repository</a></li><li><a class=padding href=https://gohugo.io/><i class="fas fa-bookmark"></i>Hugo Documentation</a></li><li><a class=padding href=https://learn.netlify.com/en/><i class="fas fa-bookmark"></i>Learn Theme Documentation</a></li></ul></section><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a>from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/docs/>The SPDL Docs Repository</a> <i class="fa fa-caret-right crumb" aria-hidden=true></i><a href=/docs/applicationnotes/>Application Notes</a> <i class="fa fa-caret-right crumb" aria-hidden=true></i>Audio Modems and the PIC</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#analog-modulation>Analog Modulation</a></li><li><a href=#tone-generation>Tone Generation</a><ul><li><a href=#single-tones>Single Tones</a></li><li><a href=#multiple-tones>Multiple Tones</a></li></ul></li><li><a href=#single-tone-decoding>Single Tone Decoding</a></li><li><a href=#multiple-tone-decoding>Multiple Tone Decoding</a><ul><li><a href=#the-goertzel-algorithm>The Goertzel Algorithm</a></li><li><a href=#generic-implementation>Generic Implementation</a></li><li><a href=#making-it-work-on-a-pic16f15356>Making it work on a PIC16F15356</a></li></ul></li><li><a href=#tradeoffs>Tradeoffs</a></li><li><a href=#references>References</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Audio Modems and the PIC</h1><p>Normally, audio signal processing is done on a dedicated digital signals processing (DSP) chip—there&rsquo;s a reason that a multiply and accumulate (MAC) instruction is the first one added, since there&rsquo;s a lot of that to go around when processing a more complicated tone of any sort.
We&rsquo;ll start by looking at what it takes to simply generate and receive clean audio tones when using the PIC, and discuss some more involved signal processing that can improve robustness and enable multiple tone detection at the cost of significant processing time<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.
The rest of this document assumes a PIC16F15356, although differences on different processors will be called out where relevant.</p><h3 id=analog-modulation>Analog Modulation</h3><p>Analog modulation works by taking a <em>carrier</em> and modulating its parameters using the data to be encoded, so that the carrier can transmit the data to whoever you&rsquo;re talking to.</p><p>If we look at a pure sine wave as a possible carrier, then what parameters do we have available to modulate?
We might describe the carrier wave as follows:</p><p>$$ C = A \sin{\omega t + \phi} $$</p><p>Where \(A\) is the amplitude, \(\omega\) the frequency<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, and \(\phi\) the phase<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><p><strong>Amplitude</strong> is the most natural modulation; for example, we can encode a <code>1</code> as a loud tone, and a <code>0</code> as a soft tone.
However, this method is not very robust to variations in the communication channel: how do you tell if the transmitting device is just farther from the microphone today, or transmitting all zeros on purpose? Is that just someone clapping in the background, or a set of ones?</p><p>What if we encode the data as variations rather than absolute levels?
This will work—this is how AM radio works—but the data rate is much lower than the carrier wave frequency.</p><p><strong>Frequency</strong> is probably the next most natural modulation; by choosing different frequencies, we can communicate different information<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.
Frequency relies on time implicitly, and since time isn&rsquo;t affected by a non-ideal transmission channel, this method is more robust than the amplitude modulation above<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>.
This type of modulation is known as <em>frequency shift keying</em> (FSK).
Typically, one frequency will be defined as the &ldquo;mark&rdquo; frequency, and will encode a <code>1</code>.
Another frequency will be defined as the &ldquo;space&rdquo; frequency, encoding <code>0</code>.
When used with only two frequencies, this method is called <em>binary</em> frequency shift keying (BFSK).
However, there&rsquo;s nothing magic about choosing only two frequencies: by choosing four frequencies, for example, each symbol can encode a dibit, potentially doubling the data rate.
The limitation is the ability of the receiver to distinguish closely spaced frequencies, and the bandwidth available in the carrier.</p><p>Dual-Tone Multiple Frequency (DTMF) encoding can also be used.
You&rsquo;ve most likely seen this if you&rsquo;ve dialed an actual landline telephone<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>.
There are several possible frequencies, and for any given symbol, two tones are superimposed, and the combined tone represents the information.
In the case of a phone, 4 &ldquo;low&rdquo; frequencies correspond to each row of the keypad, and 4 &ldquo;high&rdquo; frequencies correspond to each column of the keypad<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>.
For DTMF as implemented on a phone, this means 8 tones encode 16 symbols.
If the restriction of exactly one tone from each set is relaxed, then \(n\) tones can encode \(n(n-1)/2\) symbols.
If you define your own system and allow either 1 or 2 tones, this gives you \(n(n+1)/2\) symbols from \(n\) tones.</p><p><strong>Phase</strong> modulation is the last possible modulation, as the description of the sine wave only has three parameters.
Phase is only defined with respect to another reference—the phase of a single sine wave in isolation isn&rsquo;t well defined.
Like with amplitude, phase modulation can be done relative to the previous value of the carrier.
Phase modulation is used in many commercially implemented systems, as it offers advantages in data rate for a given bandwidth.
However, the modulation and demodulation are more complex, and so we won&rsquo;t consider this mode further here.</p><h3 id=tone-generation>Tone Generation</h3><p>We&rsquo;ll start with the transmission side of the communication channel: how do we get nice tones out of our PIC?</p><h4 id=single-tones>Single Tones</h4><p>Let&rsquo;s start with the simpler case: Let&rsquo;s say we want to generate tones of only one frequency at a time, alternating between two or more tones to convey information.</p><p>The easiest way to generate a frequency on a PIC is to use the CCP peripheral, set it up to control an output pin, and generate a square wave.<br>A square wave isn&rsquo;t very nice as an audio source though—a square wave contains all the harmonics of the frequency of the signal you&rsquo;re generating, and so if any of the components you&rsquo;re using to transduce the voltage signal to or from actual audio have any resonances, they&rsquo;ll almost certainly be excited.</p><p>The obvious solution is to filter it.
Let&rsquo;s generate a <i class=units>1&#8201;kHz</i> square wave between <i class=units>0&#8201;V</i> and <i class=units>1&#8201;V</i>, and add an RC filter with a corner at <i class=units>1.6&#8201;kHz</i>:</p><p><img src=rc_filt_1stage.png alt="single stage RC filter"></p><p>If we look at VOUT, we get the following:</p><p><img src=rc_filt_1stage_sim.png alt="single stage RC filter simulation"></p><p>which still has sharp edges and enough of the harmonics to possibly cause issues.
Let&rsquo;s add three more filter stages:</p><p><img src=rc_filt_4stage.png alt="four stage RC filter"></p><p>If we look at VOUT, we get the following:</p><p><img src=rc_filt_4stage_sim.png alt="four stage RC filter simulation"></p><p>which has only <i class=units>0.3&#8201;%</i> error from a pure sine wave at <i class=units>1&#8201;kHz</i>.
However, instead of a peak to peak amplitude of <i class=units>1&#8201;V</i>, we&rsquo;re left with a peak to peak amplitude of only <i class=units>0.19&#8201;V</i>.
Worse, let&rsquo;s say we want to transmit a range of tones, and so we feed the same filter with <i class=units>300&#8201;Hz</i>:</p><p><img src=rc_filt_4stage_300_sim.png alt="four stage RC filter simulation"></p><p>Not only are we back to more of a sharktooth shape due to the harmonics at <i class=units>900&#8201;Hz</i> and <i class=units>1500&#8201;Hz</i>, the peak-peak amplitude is now <i class=units>0.7&#8201;V</i>, which is nearly 4 times higher.
Using a passive filter like this, while simpler to implement in software, reduces signal amplitude and reduces the available frequencies to a small range<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>.
For the specific hardware we&rsquo;re using, the resulting low peak-peak amplitude is small enough that the speaker volume will not be high enough to robustly transmit information.</p><p>Generation of constant-amplitude sine waves can be achieved by using the digital-to-analog converter (DAC) peripheral on the 16F15356.
The DAC has 5-bit resolution, and outputs a constant analog voltage.
By using a lookup table and changing the DAC output at periodic intervals, a sine wave can be approximated.</p><div class="notices note"><p>Why do we want to use a lookup table and not just compute the value on the fly? It all comes down to processing time.</p><p>While a purpose-built chip intended for DSP might have the appropriate hardware instructions and clock speed to actually compute a sine function in real time, doing so would require a lot of floating-point math.
Even on chips with floating-point implemented in hardware, this will be much slower than using integer math everywhere.
On a processor like the PIC16F15356, with no hardware multiply, 8-bit word size, and a relatively low clock, doing even integer multiplication and division can be too much computation to fit into a high-rate interrupt.</p><p>Using a lookup table means that we can do all of the math ahead of time.
Usually, this means doing the computations when we&rsquo;re writing our code, on a proper computer, and inserting a <code>const</code> array in the program.
Sometimes, this can mean computing the lookup table in code, but doing it slowly outside an interrupt while there are no time-critical functions running—if the lookup table depends on measurements made while your code is running, for example.</p><p>A lookup table doesn&rsquo;t necessarily have to be a direct representation of a repeating waveform either.
If you needed to actually compute sines on a microcontroller, you&rsquo;d typically include a lookup table <code>sineTable</code> such that <code>sineTable[d]</code> held the value of \(\sin \frac{d}{2\pi}\), for example.</p></div><p>The DAC output has a high source impedance, and so it should be unity buffered; as the output is a stepped sine wave, it must also be filtered to remove harmonics.
However, here a single RC filter stage suffices to smooth the waveform sufficiently.</p><p>The lookup table can be implemented using either a fixed time reference and a desired output at each timestep, or using fixed voltage offsets and varying timesteps between output values.</p><p>One approach is to sample the waveform at a constant timestep, \(T_\mathrm{s} = 1/F_\mathrm{s}\), as seen in the following images.
By sampling the sine wave at fifteen points over a full cycle, we obtain the desired output at each point, in red.
However, these points have precise magnitude; if we assume that we can only generate multiples of 0.25, then we need to discretize these points to the possible output values, in yellow.
Finally, we output these by setting the output to the discretized value at a constant rate, resulting in the black stepped waveform.</p><p><img src="discA.png?classes=inline&width=290px" alt="sampling a sine at constant timestep">
<img src="discB.png?classes=inline&width=290px" alt=discretization>
<img src="discC.png?classes=inline&width=290px" alt="resulting discretized waveform"></p><p>In code, this might look something like</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>float</span> table[<span style=color:#ae81ff>14</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0.0</span>, <span style=color:#ae81ff>0.5</span>, <span style=color:#ae81ff>0.75</span>, <span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>1.0</span>, 
                                <span style=color:#ae81ff>0.75</span>, <span style=color:#ae81ff>0.5</span>, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.5</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.75</span>, 
                                <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.75</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.5</span>};
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</code></pre></div><p>Note that we stop at the point just before completing the cycle; when we step through this table, the next point will be index 0, ensuring a smooth repeat of the waveform.</p><div class="notices note"><p>I&rsquo;m using floats here to match the waveform exactly; remember that rule 1 of embedded microcontrollers is &ldquo;Only use integer math, and preferably only add.&rdquo;
You&rsquo;ll want to match the output values to whatever your hardware expects.</p></div><p>Our generation code, called at regular intervals, might look something like</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>output <span style=color:#f92672>=</span> table[index];
index <span style=color:#f92672>=</span> (index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> <span style=color:#ae81ff>14</span>;
</code></pre></div><p>so that the index steps through each element in turn.</p><div class="notices tip"><p>Arbitrary modulus operations (e.g. <code>++i % c</code> where c is not a power of <code>2</code>) are expensive on a low-power microcontroller.
Depending on the intelligence of the compiler, even where <code>c</code> is a power of 2, using the modulo operator <code>%</code> may result in an expensive computation.</p><p>Either use tables of length \(2^n\) and use a mask to perform the modulo (e.g. <code>++i &= 0x03</code> to count modulo <code>4</code>), or if a table of a specific length is required, check explicitly for the index reaching the table end and reassign the index: <code>if ( ++i >= len) i = 0;</code></p></div><p>Note that this previous version happens to skip 0.25 entirely.
We can also discretize by ensuring we output each possible value, and vary the time step, as here:</p><p><img src="discD.png?classes=inline&width=290px" alt="sampling a sine at each output value">
<img src="discE.png?classes=inline&width=290px" alt=discretization>
<img src="discF.png?classes=inline&width=290px" alt="resulting discretized waveform"></p><p>In this particular case, the relative timesteps are symmetric, and so we can set this up as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>float</span> table[<span style=color:#ae81ff>16</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0.25</span>, <span style=color:#ae81ff>0.5</span>, <span style=color:#ae81ff>0.75</span>, 
                                <span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>0.75</span>, <span style=color:#ae81ff>0.5</span>, <span style=color:#ae81ff>0.25</span>, 
                                <span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.25</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.5</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.75</span>, 
                                <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.75</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.5</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.25</span>};
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> delta[<span style=color:#ae81ff>16</span>] <span style=color:#f92672>=</span> {d0, d1, d2, d3, 
                                       d3, d2, d1, d0,
                                       d0, d1, d2, d3, 
                                       d3, d2, d1, d0};
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</code></pre></div><p>Our update might then look something like</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>output <span style=color:#f92672>=</span> table[index];
delayToNext <span style=color:#f92672>=</span> delta[index];
index <span style=color:#f92672>=</span> <span style=color:#f92672>++</span>index <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xF</span>;
</code></pre></div><p>Note that the delta at a given index corresponds to how long the value at that same index is output.</p><p>Both approaches allow for relatively easy modification of the output frequency when generating a single tone, by dynamically adjusting the delay between successive output values.
Using a fixed time delta simplifies this on a low-power microcontroller, as the delay scaling only needs to be calculated once per output frequency, and not once per sample.</p><p><strong>Practical Considerations:</strong></p><p>There&rsquo;s a few things to note here on how to actually implement a lookup table method like this.
The first is that looking at the example tones above, they&rsquo;re square, blocky, and not very similar to the underlying sine wave; here it&rsquo;s intentional for illustrative purposes, but that&rsquo;s not what you want if you&rsquo;re trying to generate an actual sine-like output.</p><p>Using the fixed-value variable-time approach will scale to be as good as your DAC resolution allows, and you&rsquo;ll only have to worry about running updates too quickly.
Using a fixed-time update is more flexible in terms of tuning, where the natural way to improve signal quality is to increase the update rate.</p><p>What&rsquo;s the upper bound on how fast we can go?
One constraint comes from the hardware: each DAC will have some nominal settling time, and attempting to update faster than that rate may cause a reduction in performance.
Another constraint comes from processing: even though simply copying a table value to an output takes little time, if you do it too often you&rsquo;ll be spending all your time in the interrupt and none of it running any of your actual code.
Any time you&rsquo;re setting up a control or signal processing interrupt like this, make sure you time it to see what fraction of CPU time it&rsquo;s consuming.</p><p>What&rsquo;s the lower bound on how fast we want to go?
This one is less of a bound and more of a guideline.
Fundamentally, you want to make sure you&rsquo;re running your output loop fast enough that the resulting wave looks like you want it to.
A rough rule of thumb here is to choose an update rate at least 10 times faster than the highest frequency you want to use, as long as that&rsquo;s feasible with respect to your upper bound.
If you can run the update faster, consider going fast enough that your lookup table contains each output value at least once—for example, <code>table[N] = { 0, 1, 2, 3, 3, 2, 1, 0, ...}</code> rather than <code>table[N] = { 0, 2, 3, 2, 0, -2, -3, ...}</code>.
This is a better indicator that you&rsquo;re representing the desired waveform smoothly; depending on the specific output requirements, acceptable performance may need an even faster update, but these rough guidelines can give you a good place to start.</p><p>Another note: depending on your particular microcontroller, if you have multiple lookup tables, it can be significantly faster to define each table as a 1-D array, rather than combining them as a single 2-D array—array lookups using a variable as the index can be slow.</p><h4 id=multiple-tones>Multiple Tones</h4><p>Generation of multiple tones at once can be accomplished by computing two tones, adding them in software, and then using the result to set the DAC output.
Here, it is desirable that all tones use a single interrupt, and so this suggests using a constant time delta to discretize all of the output frequencies.
To avoid discontinuities, each lookup table will correspond to a full cycle of a sine wave at a given frequency, resulting in lookup tables of differing lengths as the frequency changes.
An index into each lookup table will then need to be tracked separately, with each being incremented at a common rate.</p><p>This might look something like</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>float</span> table0[<span style=color:#ae81ff>8</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0.0</span>, <span style=color:#ae81ff>0.3</span>, <span style=color:#ae81ff>0.5</span>, <span style=color:#ae81ff>0.3</span>, <span style=color:#ae81ff>0.0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.3</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.5</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.3</span>};
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>float</span> table1[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0.0</span>, <span style=color:#ae81ff>0.5</span>, <span style=color:#ae81ff>0.0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>0.5</span>};

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> index0 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> index1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</code></pre></div><p>Note that each individual lookup table is scaled so that the sum still fits within our available output range. Another option would be to add more precise values initially, but scale before actually generating the output.
The output code might look something like</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>output <span style=color:#f92672>=</span> table0[index0] <span style=color:#f92672>+</span> table1[index1];
index0 <span style=color:#f92672>=</span> <span style=color:#f92672>++</span>index0 <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x7</span>;
index1 <span style=color:#f92672>=</span> <span style=color:#f92672>++</span>index1 <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x3</span>;
</code></pre></div><h3 id=single-tone-decoding>Single Tone Decoding</h3><p>Where decoding a single tone, if the input signal is clean enough, the normal 218A/B approach to detecting an oscillating signal serves perfectly well.
Design a series of filters to remove noise, re-center the waveform, and use a comparator to digitize the signal.
The resulting signal can then be used as an input to the CCP peripheral, and the timing between edges used to determine the frequency.</p><h3 id=multiple-tone-decoding>Multiple Tone Decoding</h3><p>If you&rsquo;re attempting to detect the presence of multiple tones at once, you&rsquo;ll have to dive in and actually do some signal processing.
For starters, connect the input signal to the analog-to-digital converter (ADC) on the chip, so that we can do some math on it.
Second, let&rsquo;s talk about that math, because there&rsquo;s a lot of it, and you need the right algorithm to have any hope of this working.</p><h4 id=the-goertzel-algorithm>The Goertzel Algorithm</h4><p>Most engineers are at least familiar with the concept of a Fast Fourier Transform (FFT), which takes in a time-varying signal, and outputs a set of amplitudes for each possible frequency<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup>.
However, calculating the full FFT (even though it&rsquo;s &ldquo;fast&rdquo;), is still very math-intensive.
If you&rsquo;re only interested in detecting a small number of frequencies out of the many possible frequencies, the Goertzel Algorithm is much more efficient in terms of total operations.</p><p>As with an FFT, the algorithm works with blocks of samples, so let&rsquo;s define some parameters:</p><p>\(F_\mathrm{s}\), the sampling frequency, in Hertz.</p><p>\(N\), the block size.</p><p>\(f_i\), the i<sup>th</sup> frequency of interest.</p><p><strong>Sample rate</strong> must be selected to satisfy at minimum the usual Nyquist constraints: \(F_\mathrm{s}\) must be at least twice the frequency of the highest frequency you want to detect. You may, however, get better results by increasing the sampling rate further. For the sake of demonstration, let&rsquo;s assume we&rsquo;ll sample at <i class=units>4&#8201;kHz</i>.</p><p><strong>Block Size</strong> is essentially a balance between specificity in detected frequency and length of the sample<sup id=fnref:10><a href=#fn:10 class=footnote-ref role=doc-noteref>10</a></sup>.
\(N\) directly controls frequency precision, as for a <i class=units>4&#8201;kHz</i> sample rate, choosing \(N=100\) will mean each response bin is <i class=units>40&#8201;Hz</i>, and frequencies less than this distance apart will be essentially impossible to distinguish.</p><p>Of course, increasing \(N\) to increase the frequency discrimination increases the sampling time (and in our case, much more so the processing time).
Choosing \(N=400\), for instance, means that it will take <i class=units>100&#8201;ms</i> just to collect the data.</p><p>You also want the target frequencies to be centered in their respective bins, which means you want \(f_i = k_i F_\mathrm{s}/N\) where the \(k_i\) are all integers.</p><p>Unlike the FFT, \(N\) can be any number, and not just powers of 2.</p><p>The algorithm can be formulated as a recursive computation, and so breaks down into computation of constants, a per-sample update, and an end-of-block magnitude calculation.</p><p><strong>Precomputed Constants:</strong></p><p>Begin by defining</p><p>$$k_i = \left\lfloor \frac{1}{2} + N\frac{f_i}{F_\mathrm{s}} \right\rfloor$$</p><p>\(k_i\) is then used to compute the required coefficients for that frequency:</p><p>$$ \begin{aligned} \omega_i &= \frac{2\pi}{N} k_i \\ C_i &= 2\cos\omega \end{aligned} $$</p><p><strong>Sample Update:</strong>
The recursive formulation of the algorithm requires the value of the previous two evaluations, and so define for each frequency three values, \(Q_0\), \(Q_1\), and \(Q_2\).
At the beginning of each block, \(Q_1\) and \(Q_2\) must be initialized to 0.</p><p>At each sample \(x\), update the values as follows:</p><p>$$ \begin{aligned} Q_0 &= C \cdot Q_1 - Q_2 + x \\ Q_2 &= Q_1 \\ Q1 &= Q_0 \end{aligned} $$</p><p><strong>Block magnitudes:</strong>
At the end of each block, the magnitude of the target frequency can be computed as</p><p>$$ M = Q_1^2 + Q_2^2 - Q_1 \cdot Q_2 \cdot C $$</p><p>Comparing \(M\) for each target frequency then tells you which of those frequencies, if any, are present in the signal.
Note that as written this ignores phase information in favor of getting a magnitude result with the minimum number of calculations.</p><h4 id=generic-implementation>Generic Implementation</h4><p>Now we can talk about implementing the algorithm on a generic microcontroller.
While for some applications it may make sense to compute the constants at runtime, particularly for smaller, RAM-constrained processors, we&rsquo;ll want to do those at compile time, so that we can place them in the flash.
For most microcontrollers, we won&rsquo;t necessarily have access to a hardware floating-point multiply, and so we&rsquo;ll also want to refactor everything to use integer math.</p><div class="notices info"><p><strong>Fixed-point</strong> math is one way of dealing with small values while not incurring the expense of floating-point operations.<br>Even where floating-point hardware exists, integer math is likely to be faster, at the cost of some precision.</p><p>A fixed-point representation of a number simply adds a virtual decimal point at a specific location in the number; for familiarity, let&rsquo;s look at some examples in base 10.</p><p>Let&rsquo;s say I want to multiply 3.4 and 1.7. The result (with an explicit decimal point) is 5.78. Now let&rsquo;s scale up the first two numbers by 10, so that they don&rsquo;t have a decimal point, giving us 34 and 17, with a product of 578. There&rsquo;s nothing magic about the decimal point, we just need to keep track of where it would be. Since we scaled both inputs by 10, the output is scaled by 100. Dividing the output by the scaling factor gives us 57, which is the result when using fixed-point decimal computation with one digit corresponding to fractions. Note that we&rsquo;ve lost some precision, since we&rsquo;re only reserving one digit to correspond to the fractional part of the result.</p><p>We can do the same thing in binary, treating a fixed number of bits \(b\) as the post-decimal-point bits, corresponding to values of 1/2, 1/4, 1/8, etc. The scale factor would then be \(S=2^b\).
Again, every multiplication will need to be scaled down by \(S\) to keep the numbers scaled correctly.
For two numbers \(a\) and \(b\), each with a scaling of \(S=2^b\), we have that the product \(p = ab/S\).
In code, this looks like <code>p = (a * b) >> b</code>.</p></div><p>Let&rsquo;s define a scaling factor of the form \(S=2^b\) where \(b\) is an integer.
Let&rsquo;s assume that we have precomputed the constants offline and put the \(C_i\) in a lookup table.
For them to be fixed-point integer types, we&rsquo;ll have to scale each constant by \(S\) and truncate as we do the computation.</p><p>Now we can define holding space for the \(Q\), and have the following set of variables:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>#define F NUM_OF_FREQUENCIES
</span><span style=color:#75715e>#define N BLOCK_SIZE
</span><span style=color:#75715e>#define b SCALING_BITS
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> int32_t C[F] <span style=color:#f92672>=</span> { ... };

<span style=color:#66d9ef>static</span> int32_t Q0;
<span style=color:#66d9ef>static</span> int32_t Q1[F];
<span style=color:#66d9ef>static</span> int32_t Q2[F];

<span style=color:#66d9ef>static</span> int32_t M[F];
</code></pre></div><p>Note that the \(C\) and \(Q\) can all be negative, hence the signed types, but the magnitude will end up being positive.</p><p>We can now go through and perform the updates as we get each sample \(x\):</p><pre><code>for (uint8_t i = 0; i &lt; F; i++){
    Q0 = x + ((C[i]*Q1[i])&gt;&gt;b) - Q2[i];
    Q2[i] = Q1[i];
    Q1[i] = Q0[i];
}
</code></pre><p>where we shift right by \(b\) bits to maintain scaling.</p><div class="notices warning"><p>In C99, technically using <code>>></code> to shift a signed value is undefined and compiler dependent. Most compilers will perform an arithmetic shift (i.e. extending the sign bits, resulting in division), but it&rsquo;s always good to double check. The MPLAB XC8 C compiler does in fact perform an arithmetic right shift on negative numbers.</p></div><p>And finally, at the end of the block, we update the magnitudes:</p><pre><code>for (uint8_t i = 0; i &lt; F; i++){
    M[i] = ((Q1[i]*Q1[i])&gt;&gt;b) + 
           ((Q2[i]*Q2[i])&gt;&gt;b) - 
           (( ((Q1[i]*Q2[i])&gt;&gt;b) * C[i])&gt;&gt;b);
}
</code></pre><p>Where the final term is bit shifted twice to maintain scaling.</p><div class="notices note"><p>At this point, if you have a 32-bit microcontroller and it has a hardware multiply instruction (e.g. the Tiva), you&rsquo;re set! fixed-point integer math should mean that this algorithm is fast enough to run real-time, running one sample update each time you make a measurement. Unfortunately, the same cannot be said for an 8-bit PIC with no hardware multiply.</p></div><h4 id=making-it-work-on-a-pic16f15356>Making it work on a PIC16F15356</h4><p>You&rsquo;ll notice that there are a lot of 32-bit multiplications in the previous generic implementation.
The PIC16F15356, on the other hand, doesn&rsquo;t even have an 8-bit multiply instruction, and if you try to implement the full 32-bit version above, you&rsquo;ll be waiting a very long time to get any results.</p><p>However, we can make a lot of optimizations that allow us to improve the processing time to where this could be feasible for low-baud rate communication with a complex symbol set to keep a reasonable data rate<sup id=fnref:11><a href=#fn:11 class=footnote-ref role=doc-noteref>11</a></sup>.</p><p>Let&rsquo;s start with the fixed-point scaling, \(b\).
We definitely want this to be 8 in this case—the PIC is an 8-bit processor, and handling things in 8-bit chunks is a natural fit. The precomputed cosine term ends up being <em>about</em> 1 for most target frequencies, and so using an 8 bit scaling factor means we can represent it at taking 8 bits.</p><div class="notices note"><p>Multiplication and digits in the resulting representation will end up being critical for these optimizations. Let&rsquo;s say we have a number in base \(B\), having \(k\) digits.
The largest \(k\)-digit number is then given by \(B^k-1\); e.g. the largest 2-bit number is \(2^2-1 = 3 = 0\mathrm{b}11\).
If we multiply the largest \(n\)-digit number with the largest \(m\)-digit number, we get
$$ (B^n-1)(B^m-1) = B^{n+m} - B^n - B^m + 1$$</p><p>\(B^{n+m}\) is the smallest number with \(n+m+1\) digits; with the two subtractions, we therefore know that the product has at most \(n+m\) digits.
This is an excessively involved way of saying that 99 times 99 is less than 10,000.
The useful part is that if we take an 8-bit number and multiply it with an 8-bit number, we know we can represent the result with at most 16 bits.</p></div><p>The first part of our new setup is to store all the measurements in a buffer, as we know we won&rsquo;t be able to do the math fast enough to do it live in the interrupt.
We can define a buffer <code>static volatile uint8_t data[N]</code> to store the values in each block of measurements, along with a flag <code>static volatile bool dataReady</code> to indicate to the main program when the block has been measured.
Whether or not the ADC has 8-bits of resolution, we&rsquo;ll only take the measurement as an 8-bit number to keep everything byte-aligned.</p><p>For these inputs (C is 8/9 bits, data is 8 bits), the Q end up being 16 bits each, and are signed types, so we have, for example, the set of Q for the zeroth frequency to detect defined as <code>static int16_t Q0[3]</code>, such that <code>Q0[0]</code> is \(Q_0\) for frequency 0, <code>Q0[1]</code> is \(Q_1\) for frequency 0, and so on.</p><p>Some 32-bit multiplications are unavoidable, but the bit shift afterward also turns out to be somewhat expensive on our PIC.
To get around this, we&rsquo;ll use a custom type and a <code>union</code> to directly access the bytes we want.</p><div class="notices info"><p>In C, a <code>union</code> is essentially just telling the compiler you want to treat an area of memory as multiple formats, depending on how you perform the access—in English, it&rsquo;s something like &ldquo;I want this area of memory to behave like a 16-bit number when I access it using the name <code>number</code>, and as a 2-element byte array when I access it using the name <code>bytes</code>&rdquo;</p></div><p>Each step of processing involves multiplying \(Q_1 \cdot C\), which is a 16-bit and an 8-bit<sup id=fnref:12><a href=#fn:12 class=footnote-ref role=doc-noteref>12</a></sup> number, resulting in a 24-bit number. Rather than shifting the result by 8 bits, we&rsquo;ll define a custom type as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>struct</span> ltype {
    int8_t trunc;
    int16_t intval; <span style=color:#75715e>// access middle two bytes directly to avoid division
</span><span style=color:#75715e></span>    int8_t space;
};

<span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>union</span> RESULT_T {
    int32_t l;
    <span style=color:#66d9ef>struct</span> ltype hold; <span style=color:#75715e>// Allows direct access to bytes of 16-bit data
</span><span style=color:#75715e></span>} RESULT_T;

<span style=color:#66d9ef>static</span> RESULT_T Qhold; <span style=color:#75715e>// Holding space for intermediate calculations
</span></code></pre></div><p>The <code>ltype</code> struct defines a 4-byte region of memory, as an 8-bit, 16-bit, and 8-bit chunk in series.
As the PIC is little-endian, the least-significant bytes come first, so <code>trunc</code> is the LSBs we throw away, <code>intval</code> is the final 16-bit result we&rsquo;re after after shifting by our 8-bit scale factor, and <code>space</code> is ideally extra space that never holds data.
The <code>RESULT_T</code> type is a union, so we can treat the 4-byte region as a single 32-bit type using <code>l</code>, or as a struct using <code>hold</code>.
So we do the multiplication, and put the result into <code>Qhold.l</code>, treating the memory location as a long.
We then pull out the scaled result by accessing <code>Qhold.hold.intval</code>, and proceed with the update:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>// per-sample filter update
</span><span style=color:#75715e>// assume new sample (uint8_t) is in data[i]
</span><span style=color:#75715e></span>int16_t x;
x <span style=color:#f92672>=</span> data[i] <span style=color:#f92672>-</span> <span style=color:#ae81ff>127</span>; <span style=color:#75715e>// center around zero to reduce 
</span><span style=color:#75715e></span>                   <span style=color:#75715e>// size of computed Q
</span><span style=color:#75715e></span>
<span style=color:#75715e>// assume we&#39;re processing frequency n
</span><span style=color:#75715e></span>Qhold.l <span style=color:#f92672>=</span> (int32_t) Cn <span style=color:#f92672>*</span> (int32_t) Qn[<span style=color:#ae81ff>1</span>];
Qn[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> x;
Qn[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+=</span> Qhold.hold.intval;
Qn[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>-=</span> Qn[<span style=color:#ae81ff>2</span>];
Qn[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> Qn[<span style=color:#ae81ff>1</span>];
Qn[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> Qn[<span style=color:#ae81ff>0</span>];
</code></pre></div><p>At this point, after having computed all of the per-stage updates, we have \(Q_1\) and \(Q_2\) which are each 16-bit values.<br>The magnitude computation involves squaring each \(Q\), as well as multiplying \(Q_1\), \(Q_2\), and \(C\).
Without any adjustment, this last multiplication would give us a 4-bit number.
However, at this point we&rsquo;re only interested in relative magnitude, and each term has two copies of a \(Q\) term—if we scale the \(Q\) to 8 bits at this point, then the result is a 24-bit number, and we can use the same struct to extract the final 16-bit value.</p><p>However, the \(Q\) are, at this point, of variable size, and so we&rsquo;ll run through them to see how many bits each actually requires to represent.
We&rsquo;ll define <code>uint16_t bitTest = 0</code> and <code>uint8_t shift = 0</code>.</p><p>For each frequency n, check how many bits \(Q_1\) and \(Q_2\) take:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>if</span> (Qn[<span style=color:#ae81ff>1</span>].i <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>) bitTest <span style=color:#f92672>|=</span> Qn[<span style=color:#ae81ff>1</span>].i;
<span style=color:#66d9ef>else</span> bitTest <span style=color:#f92672>|=</span> (<span style=color:#f92672>~</span>Qn[<span style=color:#ae81ff>1</span>].i) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>1</span>;
<span style=color:#66d9ef>if</span> (Qn[<span style=color:#ae81ff>2</span>].i <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>) bitTest <span style=color:#f92672>|=</span> Qn[<span style=color:#ae81ff>2</span>].i;
<span style=color:#66d9ef>else</span> bitTest <span style=color:#f92672>|=</span> (<span style=color:#f92672>~</span>Qn[<span style=color:#ae81ff>2</span>].i) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>1</span>;
</code></pre></div><p>For positive numbers, the leading bits will be <code>0</code>, so we can simply or the number to find the highest bit that was set.
For negative numbers, the leading bits are <code>1</code>, and so we need to find the last bit that is set before the first leading zero (due to the two&rsquo;s complement representation and needing to keep a sign bit). We do this by inverting the bits and left-shifting by one, then combining with <code>bitTest</code>.</p><p>After doing this for all frequencies, we know the maximum size of all of the \(Q\), and so we can compute a bit shift based on the largest:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>// Compute shift from highest bit that is set
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (bitTest <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>15</span>)) shift <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;
<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (bitTest <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>14</span>)) shift <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>;
<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (bitTest <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>13</span>)) shift <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;
<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (bitTest <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>12</span>)) shift <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (bitTest <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>11</span>)) shift <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (bitTest <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>10</span>)) shift <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (bitTest <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>9</span>)) shift <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (bitTest <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>8</span>)) shift <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</code></pre></div><p>and then for each frequency, shift to make it exactly 8 bits:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>// Filter n Update
</span><span style=color:#75715e></span>Qn[<span style=color:#ae81ff>1</span>].i <span style=color:#f92672>&gt;&gt;=</span> shift;
Qn[<span style=color:#ae81ff>2</span>].i <span style=color:#f92672>&gt;&gt;=</span> shift;
</code></pre></div><p>Now we can do the multiplication, putting the result in <code>Qhold</code>, then extracting and adding to the \(Q^2\) terms which are each 16-bit:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>// Filter n magnitude calculation
</span><span style=color:#75715e></span>Qhold.l <span style=color:#f92672>=</span> (int32_t) Qn[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>*</span> (int32_t) Qn[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>*</span> (int32_t) Cn;
M[n] <span style=color:#f92672>=</span> ((Qn[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>*</span> Qn[<span style=color:#ae81ff>1</span>])
       <span style=color:#f92672>+</span>(Qn[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>*</span> Qn[<span style=color:#ae81ff>2</span>])
       <span style=color:#f92672>-</span>(Qhold.hold.intval));
<span style=color:#75715e>// Reset Filter n
</span><span style=color:#75715e></span>Qn[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
Qn[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</code></pre></div><p>And now you can inspect <code>M</code> to figure out which, if any, frequencies are present.
Note that for speed, everything is explicitly defined—nowhere do we reference an array with a non-constant index, except when getting measurements in and out of the <code>data</code> buffer.
This means that yes, your code will involve lots of copies of the same code with different literal indices inserted.
As you&rsquo;d be generating these tables over and over again to adjust and debug, I&rsquo;d suggest using Python or MATLAB and code templates to statically generate your copy-pasted code on demand.
That way, you can debug the structure of the code once, and then automatically generate lookup tables, <code>Qn</code> constants, and so on as you change frequencies, number of distinct frequencies, and so on.</p><h3 id=tradeoffs>Tradeoffs</h3><p>Of course, the PIC16F15356 is by no means a DSP chip.
Implementing a DTMF approach will necessarily reduce your baud rate, as (roughly speaking), detecting 8 frequencies with a sample rate of <i class=units>4&#8201;kHz</i> and a block size of 47 takes about <i class=units>12&#8201;ms</i> to measure, but about a further <i class=units>60&#8201;ms</i> to process.
This means each symbol must be spaced far enough apart for listening devices to be able to complete measurement of the previous symbol, resulting in a baud rate of about 10. However, it&rsquo;s feasible to have a large symbol set of maybe 20 symbols, meaning the bit rate can still be about 40-50.
Reducing the baud rate further and increasing the block size can allow for more finely-spaced signals, which should be able to further increase the bit rate.</p><p>Using the DSP approach does also offer more robustness to relatively-low amplitude harmonics that cannot be easily filtered due to the characteristics of the physical transmission channel (e.g. cheap speakers or microphones, etc.)</p><p>On the other hand, generating single tones allows for ease of detection, as the signal can be digitized, and zero-crossings precisely timed to extract a frequency.
For a signal using BFSK near <i class=units>500&#8201;Hz</i><sup id=fnref:13><a href=#fn:13 class=footnote-ref role=doc-noteref>13</a></sup>, if we assume that robust detection of a bit takes 10 zero-crossings, then your baud rate (and bit rate) is 50.
Increasing the number of symbols can again improve your bit rate; using 4 tones and encoding dibits improves your bit rate to 100.</p><p>In terms of tone generation, both approaches are about comparable, as the lookup table and interrupt setup are nearly identical in both cases.</p><hr><h3 id=references>References</h3><ol><li>G. Held, &ldquo;Asynchronous Modems and Interfaces,&rdquo; in <em>Understanding Data Communications</em>, 2<sup>nd</sup> ed., Howard W Sams & Company, 1987.</li><li>&ldquo;The Goertzel Algorithm,&rdquo; <em>Embedded</em>, 28 Aug 2002. <a href=https://www.embedded.com/the-goertzel-algorithm/>Online</a>.</li><li>A. Vitali, &ldquo;The Goertzel algorithm to compute individual terms of the discrete Fourier transform (DFT),&rdquo; DT0089, ST Microelectronics , 2017.</li><li>Silicon Labs, &ldquo;DTMF Decoder Reference Design,&rdquo; AN218, 2005.</li></ol><hr><p>Contributed by Arul Suresh, 1 May 2020.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>At least, on a PIC that doesn&rsquo;t have a hardware multiply, is 8-bits, and running on only a <i class=units>32&#8201;MHz</i> clock. <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>In radians per second; the frequency in cycles per second (i.e. Hertz) is given by \(f = \frac{\omega}{2 \pi}\). <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>Again, in radians. <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>For a reference implementation of this method, see the &ldquo;Police Station (Silly Voices)&rdquo; sketch from Monty Python&rsquo;s Flying Circus, Series 1, Ep. 12: <em>The Naked Ant</em>. <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote><p>Of course, this will still have issues if one of you is moving toward and away from the microphone or speaker at an appreciable fraction of the speed of sound. Or if you&rsquo;re traveling at relativistic speeds and time behaves differently. Or if you&rsquo;re trying to communicate between a Nitrogen and Helium atmosphere. But for most cases, it works great! <a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6 role=doc-endnote><p>Let&rsquo;s be real, this is rapidly approaching the point of &ldquo;no one but Ed has had this experience,&rdquo; if we&rsquo;re not already there yet. <a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7 role=doc-endnote><p>Yes, I said 4 columns! The characters are A, B, C, and D, although keypads actually using those buttons were phased out way before DTMF on actual phones was. The corresponding tones are often used as control signals. <a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8 role=doc-endnote><p>If we assume an ideal filter such that all frequencies below the filter bandwidth \(f_\mathrm{BW}\) are passed with unity gain, and all frequencies above are perfectly blocked, the range of usable frequencies is \(\frac{1}{3}f_\mathrm{BW} &lt; f &lt; f_\mathrm{BW}\). Since the filter rolloff is not ideal, the available frequency range will be smaller; if roughly equal amplitude is required, it will be smaller still. <a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:9 role=doc-endnote><p>Frequencies from \(0\) to \(F_\mathrm{s}/2\), since any frequency above that cannot be detected because of the Nyquist Theorem. <a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:10 role=doc-endnote><p>For a related discussion on frequency, duration, and precision, check out <a href="https://www.youtube.com/watch?v=MBnnXbOM5S4">3blue1brown&rsquo;s excellent video</a> on the underlying math. <a href=#fnref:10 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:11 role=doc-endnote><p>Plus, it&rsquo;s cool! Definitely pushing the hardware is an interesting way to figure out what is and isn&rsquo;t possible. <a href=#fnref:11 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:12 role=doc-endnote><p>Well, 8-<em>ish</em> bits. But even though it&rsquo;s often actually 9-bits to represent (because \(C = 2S\cos\omega \approx 2*256 = 512\)), it&rsquo;s one of the smaller possible 9-bit numbers, and so in practice treating it as 8 for the purposes of calculating scaling works out fine. <a href=#fnref:12 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:13 role=doc-endnote><p>You probably want to stick to tones under <i class=units>1&#8201;kHz</i> for your own sanity. High pitched tones are <em>really annoying</em>—take a look at the <a href=https://en.wikipedia.org/wiki/Equal-loudness_contour>Fletcher-Munson curves</a>. <a href=#fnref:13 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/docs/applicationnotes/magneticfieldsensing/ title="Magnetic Field Sensing"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=/docs/applicationnotes/magneticfieldsensing/ title="Magnetic Field Sensing" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/docs/js/clipboard.min.js?1588666478></script><script src=/docs/js/perfect-scrollbar.min.js?1588666478></script><script src=/docs/js/perfect-scrollbar.jquery.min.js?1588666478></script><script src=/docs/js/jquery.sticky.js?1588666478></script><script src=/docs/js/featherlight.min.js?1588666478></script><script src=/docs/js/highlight.pack.js?1588666478></script><script>hljs.initHighlightingOnLoad();</script><script src=/docs/js/modernizr.custom-3.6.0.js?1588666478></script><script src=/docs/js/learn.js?1588666478></script><script src=/docs/js/hugo-learn.js?1588666478></script><link href=/docs/mermaid/mermaid.css?1588666478 rel=stylesheet><script src=/docs/mermaid/mermaid.js?1588666478></script><script>mermaid.initialize({startOnLoad:true});</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body);></script><script type=text/javascript src=/docs/js/bigfoot.min.js></script><script type=text/javascript>$.bigfoot();</script></body></html>